<% /* Login view fixed
   - Added safe defaults so no undefined error
   - Comments simplified to what I’d normally write
*/ %>

<h1><%= title %></h1>

<%- messages() %>

<% const _errors = Array.isArray(errors) ? errors : [] %>
<% const stickyEmail = typeof account_email !== "undefined" ? account_email : (locals && locals.account_email) || "" %>
<% const hasErr = (n) => _errors.some(e => (e.path || e.param) === n) %>
<% const firstErrMsg = (n) => { const hit = _errors.find(e => (e.path || e.param) === n); return hit ? hit.msg : null } %>

<% if (_errors.length) { %>
  <div class="form-errors" role="alert" aria-live="assertive">
    <ul>
      <% _errors.forEach(err => { %><li><%= err.msg %></li><% }) %>
    </ul>
  </div>
<% } %>

<section class="account-auth">
  <form id="loginForm" class="auth-form" action="/account/login" method="post" novalidate>
    <div class="form-row">
      <label for="account_email">Email address</label>
      <input
        id="account_email"
        name="account_email"
        type="email"
        placeholder="you@example.com"
        required
        autocomplete="username"
        value="<%= stickyEmail %>"
        aria-invalid="<%= hasErr('account_email') ? 'true' : 'false' %>">
      <% if (hasErr('account_email')) { %>
        <small class="field-error"><%= firstErrMsg('account_email') %></small>
      <% } %>
    </div>

    <div class="form-row">
      <label for="account_password">Password</label>
      <input
        id="account_password"
        name="account_password"
        type="password"
        placeholder="••••••••"
        required
        autocomplete="current-password"
        aria-invalid="<%= hasErr('account_password') ? 'true' : 'false' %>">
      <% if (hasErr('account_password')) { %>
        <small class="field-error"><%= firstErrMsg('account_password') %></small>
      <% } %>
    </div>

    <div class="form-actions">
      <button class="btn" type="submit">Sign in</button>
    </div>
  </form>

  <p class="auth-alt">
    Don’t have an account?
    <a href="/account/register">Create one</a>
  </p>
</section>

<script>
  // Simple check before sending the form
  (function(){
    const form = document.getElementById("loginForm")
    if(!form) return
    form.addEventListener("submit", e=>{
      const email = document.getElementById("account_email")
      const pass = document.getElementById("account_password")
      if(!email.value.trim() || !pass.value.trim()){
        e.preventDefault()
        if(!email.value.trim()) email.setAttribute("aria-invalid","true")
        if(!pass.value.trim()) pass.setAttribute("aria-invalid","true")
      }
    })
  })()
</script>
